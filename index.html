<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Custom Selector</title>
    <style>
      body,
      html {
        margin: 0;
        padding: 0;
      }
      .hidden {
        display: none;
      }
      .options {
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid #ccc;
        position: absolute;
        background: white;
        z-index: 1000;
      }
      .options ul {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      .generated_selector_search {
        width: 100%;
      }
      .pseudo-selector {
        cursor: pointer;
        box-sizing: border-box;
        display: block;
        padding: 8px;
        width: 100%;
        border-radius: 4px;
        border: 1px solid #b7b1b1;
      }
      .options li {
        padding: 8px;
        cursor: pointer;
      }
      .options li:hover {
        background-color: #f0f0f0;
      }
      .options li.selected {
        background-color: #d0eaff;
      }
      .active_option {
        background-color: #d0eaff;
        padding: 5px;
        margin: 3px;
        border-radius: 4px;
        display: inline-block;
      }
      .options {
        width: 100%;
      }
    </style>
  </head>
  <body>
    <section>
      <div class="selector_wrapper">
        <!-- 
        class: 
        selector_generator: initiates logic
        searchable: enables search input

        attribute:
        multiple: enables multiple select
       -->

        <select
          class="hidden selector_generator searchable"
          data-selector-id="58-sxf9"
          multiple
        >
          <option value="MN" data-selector-id="select2-data-89-6goi">
            Minnesota
          </option>
          <option value="MS" data-selector-id="select2-data-90-gnme">
            Mississippi
          </option>
          <option value="MO" data-selector-id="select2-data-91-mhyk">
            Missouri
          </option>
          <option value="OK" data-selector-id="select2-data-92-na2p">
            Oklahoma
          </option>
          <option value="SD" data-selector-id="select2-data-93-2p3l">
            South Dakota
          </option>
          <option value="TX" data-selector-id="select2-data-94-vvt2">
            Texas
          </option>
          <option value="TN" data-selector-id="select2-data-95-kmxm">
            Tennessee
          </option>
          <option value="WI" data-selector-id="select2-data-96-ga2h">
            Wisconsin
          </option>
        </select>
      </div>

      <div class="selector_wrapper">
        <select class="hidden selector_generator" data-selector-id="58-sxf9">
          <option value="1AZ" data-selector-id="select2-data-73-p2o4">
            Arizona
          </option>
          <option value="1CO" data-selector-id="select2-data-74-vwsb">
            Colorado
          </option>
          <option value="1ID" data-selector-id="select2-data-75-a7ep">
            Idaho
          </option>
          <option value="1MT" data-selector-id="select2-data-76-nj1g">
            Montana
          </option>
          <option value="1NE" data-selector-id="select2-data-77-91y7">
            Nebraska
          </option>
          <option value="1NM" data-selector-id="select2-data-78-rx2r">
            New Mexico
          </option>
          <option value="1ND" data-selector-id="select2-data-79-00iu">
            North Dakota
          </option>
          <option value="1UT" data-selector-id="select2-data-80-mau7">
            Utah
          </option>
          <option value="1WY" data-selector-id="select2-data-64-6pnl">
            Wyoming
          </option>
        </select>
      </div>
    </section>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const selectorWrappers = document.querySelectorAll(".selector_wrapper");

        selectorWrappers.forEach((selectorWrapper) => {
          const selectElement = selectorWrapper.querySelector(
            "select.selector_generator"
          );

          if (selectElement) {
            const pseudoSelector = document.createElement("span");
            pseudoSelector.className = "pseudo-selector";
            pseudoSelector.textContent = "Select options";

            const optionsContainer = document.createElement("div");
            optionsContainer.className = "options hidden";

            const optionsList = document.createElement("ul");

            selectElement.selectedIndex = -1;

            const optionElements = Array.from(selectElement.options).map(
              (option) => ({
                text: option.textContent,
                value: option.value,
              })
            );

            optionElements.forEach((option) => {
              const li = document.createElement("li");
              li.textContent = option.text;
              li.dataset.value = option.value;
              li.addEventListener("click", () => {
                handleOptionClick(
                  li,
                  selectElement,
                  optionsList,
                  pseudoSelector,
                  optionElements
                );
              });
              optionsList.appendChild(li);
            });

            optionsContainer.appendChild(optionsList);
            selectorWrapper.appendChild(pseudoSelector);
            selectorWrapper.appendChild(optionsContainer);

            pseudoSelector.addEventListener("click", () => {
              optionsContainer.classList.toggle("hidden");
            });

            document.addEventListener("click", (event) => {
              if (
                !optionsContainer.contains(event.target) &&
                event.target !== pseudoSelector
              ) {
                optionsContainer.classList.add("hidden");
              }
            });

            if (selectElement.classList.contains("searchable")) {
              const searchInput = document.createElement("input");
              searchInput.type = "text";
              searchInput.classList.add("generated_selector_search");
              searchInput.placeholder = "Search options...";
              searchInput.addEventListener(
                "input",
                debounce(() => filterOptions(searchInput, optionsList), 300)
              );
              optionsContainer.insertBefore(searchInput, optionsList);
            }

            updatePseudoSelectorText(
              pseudoSelector,
              selectElement,
              optionsList
            );
          }
        });
      });

      function handleOptionClick(
        li,
        selectElement,
        optionsList,
        pseudoSelector,
        optionElements
      ) {
        const selectedValue = li.dataset.value;
        const selectedOption = selectElement.querySelector(
          `option[value="${selectedValue}"]`
        );

        if (!selectedOption) return;

        const isMultiple = selectElement.hasAttribute("multiple");

        if (isMultiple) {
          if (selectedOption.selected) {
            selectedOption.selected = false;
            addOptionInOrder(
              optionsList,
              selectedValue,
              optionElements,
              pseudoSelector,
              selectElement
            );
          } else {
            selectedOption.selected = true;
            li.remove();
          }
        } else {
          li.remove();
          if (!selectedOption.selected) {
            optionsList.innerHTML = "";

            optionElements.forEach((option) => {
              if (option.value !== selectedValue) {
                const newLi = document.createElement("li");
                newLi.textContent = option.text;
                newLi.dataset.value = option.value;
                newLi.addEventListener("click", (event) => {
                  handleOptionClick(
                    event.target,
                    selectElement,
                    optionsList,
                    pseudoSelector,
                    optionElements
                  );
                });

                optionsList.appendChild(newLi);
              }
            });

            selectedOption.selected = true;
            optionsList.closest(".options").classList.add("hidden");
          }
        }
        if (!isMultiple && selectedOption.selected === false) {
          selectElement.value = "";
        }
        updatePseudoSelectorText(pseudoSelector, selectElement, optionsList);
      }

      function updatePseudoSelectorText(
        pseudoSelector,
        selectElement,
        optionsList
      ) {
        pseudoSelector.innerHTML = "";

        const selectedOptions = Array.from(selectElement.options).filter(
          (option) => option.selected
        );

        if (selectedOptions.length > 0) {
          selectedOptions.forEach((option) => {
            const span = document.createElement("span");
            span.className = "active_option";
            span.textContent = option.textContent;
            span.dataset.value = option.value;

            span.addEventListener("click", (event) => {
              event.stopPropagation();
              const value = span.dataset.value;
              const optionToDeselect = selectElement.querySelector(
                `option[value="${value}"]`
              );
              optionToDeselect.selected = false;
              span.remove();
              addOptionInOrder(
                optionsList,
                value,
                Array.from(selectElement.options).map((opt) => ({
                  text: opt.textContent,
                  value: opt.value,
                })),
                pseudoSelector,
                selectElement
              );

              if (pseudoSelector.innerHTML === "") {
                pseudoSelector.textContent = "Select options";
              }
            });

            pseudoSelector.appendChild(span);
          });
        } else {
          pseudoSelector.textContent = "Select options";
        }
      }

      function addOptionInOrder(
        optionsList,
        value,
        optionElements,
        pseudoSelector,
        selectElement
      ) {
        const optionToAdd = optionElements.find(
          (option) => option.value === value
        );

        const li = document.createElement("li");
        li.textContent = optionToAdd.text;
        li.dataset.value = optionToAdd.value;
        li.addEventListener("click", (event) => {
          handleOptionClick(
            event.target,
            selectElement,
            optionsList,
            pseudoSelector,
            optionElements
          );
        });

        const currentOptions = Array.from(optionsList.children);
        let inserted = false;
        for (let i = 0; i < currentOptions.length; i++) {
          if (
            optionElements.findIndex(
              (option) => option.value === currentOptions[i].dataset.value
            ) > optionElements.findIndex((option) => option.value === value)
          ) {
            optionsList.insertBefore(li, currentOptions[i]);
            inserted = true;
            break;
          }
        }
        if (!inserted) {
          optionsList.appendChild(li);
        }
      }

      function filterOptions(searchInput, optionsList) {
        const searchText = searchInput.value.toLowerCase();
        Array.from(optionsList.children).forEach((li) => {
          const optionText = li.textContent.toLowerCase();
          li.style.display = optionText.includes(searchText) ? "block" : "none";
        });
      }

      function debounce(func, wait) {
        let timeout;
        return function (...args) {
          const later = () => {
            clearTimeout(timeout);
            func.apply(this, args);
          };
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
        };
      }
    </script>
  </body>
</html>
